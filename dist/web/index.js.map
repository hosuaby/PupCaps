{"version":3,"file":"index.js","sources":["../../src/web/renderer.ts","../../src/web/timeline.ts","../../src/web/player.ts","../../src/web/components/player.component.vue","../../src/web/index.ts"],"sourcesContent":["import {Caption, Word} from '../common/caption';\n\nfunction renderWord(word: Word): HTMLSpanElement {\n    const wordSpan = document.createElement('span');\n    wordSpan.textContent = word.rawWord;\n\n    let cssClass = 'word'\n    if (word.isHighlighted) {\n        cssClass += ' highlighted';\n    } if (word.isBeforeHighlighted) {\n        cssClass += ' before-highlighted';\n    } if (word.isAfterHighlighted) {\n        cssClass += ' after-highlighted';\n    }\n\n    wordSpan.setAttribute('class', cssClass);\n\n    return wordSpan;\n}\n\nexport function renderCaption(caption: Caption): HTMLDivElement {\n    const captionDiv = document.createElement('div');\n    captionDiv.setAttribute('id', `caption_${caption.index}`);\n    captionDiv.setAttribute('class', 'caption');\n\n    caption.words\n        .map(renderWord)\n        .forEach(spanElem => captionDiv.appendChild(spanElem));\n\n    return captionDiv;\n}","interface Task {\n    timeMs: number;\n    task: () => void;\n}\n\nexport class Timeline {\n    private readonly tasks: Task[] = [];\n    private timeoutId: NodeJS.Timeout | null = null;\n\n    constructor(private readonly onEnd: () => void) {\n    }\n\n    public schedule(timeMs: number, task: () => void) {\n        this.tasks.push({ timeMs, task });\n    }\n\n    public run() {\n        this.tasks.sort((a, b) => a.timeMs - b.timeMs);\n\n        if (!this.tasks.length) {\n            throw new Error('Event queue is empty!');\n        }\n\n        const first = this.tasks[0];\n        this.timeoutId = setTimeout(() => this.exec(first.timeMs, 0), first.timeMs);\n    }\n\n    public stop() {\n        clearTimeout(this.timeoutId!);\n        this.onEnd();\n    }\n\n    private exec(timeMs: number, index: number) {\n        this.tasks[index].task();\n\n        if (index < this.tasks.length - 1) {\n            const next = this.tasks[index + 1];\n            const timeout = next.timeMs - timeMs;\n            this.timeoutId = setTimeout(() => this.exec(next.timeMs, index + 1), timeout);\n        } else {\n            this.onEnd();\n        }\n    }\n}","import {Caption} from '../common/caption';\nimport {renderCaption} from './renderer';\nimport {Timeline} from './timeline';\n\ninterface Event {\n    timeMs: number;\n    toShow: HTMLDivElement[];\n    toHide: HTMLDivElement[];\n}\n\ninterface Events {\n    [key: number]: Event;\n}\n\nexport class Player {\n    public onStop = () => {};\n\n    private index = 0;\n    private readonly captionsContainer: Element;\n    private readonly rendered: HTMLDivElement[] = [];\n    private timeline: Timeline | null = null;\n\n    constructor(private readonly videoElem: HTMLElement,\n                private readonly captions: Caption[]) {\n        this.captionsContainer = this.videoElem.querySelector('.captions')!;\n\n        for (const caption of captions) {\n            this.rendered[caption.index] = renderCaption(caption);\n        }\n    }\n\n    public play() {\n        this.index = 0;\n        this.rendered.forEach(captionElem => captionElem.remove());\n\n        const eventTimeline: Events = {};\n\n        for (let i = 0; i < this.captions.length; i++) {\n            const caption = this.captions[i];\n\n            eventTimeline[caption.startTimeMs] ||= {\n                timeMs: caption.startTimeMs,\n                toShow: [],\n                toHide: [],\n            }\n\n            eventTimeline[caption.endTimeMs] ||= {\n                timeMs: caption.endTimeMs,\n                toShow: [],\n                toHide: [],\n            }\n\n            const renderedIndex = i + 1;\n            eventTimeline[caption.startTimeMs].toShow.push(this.rendered[renderedIndex]);\n            eventTimeline[caption.endTimeMs].toHide.push(this.rendered[renderedIndex]);\n        }\n\n        this.timeline = new Timeline(this.onStop);\n\n        for (const event of Object.values(eventTimeline) as Event[]) {\n            this.timeline!.schedule(event.timeMs, () => {\n                event.toHide.forEach(elem => elem.remove());\n                event.toShow.forEach(elem => this.captionsContainer.appendChild(elem));\n            });\n        }\n\n        this.timeline.run();\n    }\n\n    public stop() {\n        this.timeline!.stop();\n        this.rendered.forEach(elem => elem.remove());\n        this.index = 0;\n    }\n\n    public prec() {\n        if (!this.isBeginning) {\n            const oldCaptionElem = this.rendered[this.index];\n            oldCaptionElem.remove();\n            this.index--;\n\n            if (!this.isBeginning) {\n                const newCaptionElem = this.rendered[this.index]\n                this.captionsContainer.appendChild(newCaptionElem);\n            }\n        }\n    }\n\n    public next() {\n        if (!this.isEnd) {\n            if (this.index) {\n                const oldCaptionElem = this.rendered[this.index];\n                oldCaptionElem.remove();\n            }\n\n            this.index++;\n            const newCaptionElem = this.rendered[this.index]\n            this.captionsContainer.appendChild(newCaptionElem);\n        }\n    }\n\n    public get isBeginning(): boolean {\n        return this.index === 0;\n    }\n\n    public get isEnd(): boolean {\n        return this.index === this.captions.length\n    }\n}","<script setup lang=\"ts\">\nimport {reactive} from 'vue';\n\nconst playerState = reactive({\n  isPlaying: false,\n  isBeginning: window.Player.isBeginning,\n  isEnd: window.Player.isEnd,\n});\n\nwindow.Player.onStop = () => {\n  playerState.isPlaying = false;\n};\n\nfunction prec() {\n  window.Player.prec();\n  updateState();\n}\n\nfunction next() {\n  window.Player.next();\n  updateState();\n}\n\nfunction togglePlay() {\n  if (!playerState.isPlaying) {\n    window.Player.play();\n    playerState.isPlaying = true;\n  } else {\n    window.Player.stop();\n  }\n}\n\nfunction updateState() {\n  playerState.isBeginning = window.Player.isBeginning;\n  playerState.isEnd = window.Player.isEnd;\n}\n</script>\n\n<template>\n  <div class=\"field has-addons has-addons-centered\">\n    <p class=\"control\">\n      <button class=\"button is-rounded\"\n              :disabled=\"playerState.isBeginning || playerState.isPlaying\"\n              @click=\"prec()\">\n        <span class=\"icon is-small\">\n          <i class=\"fa fa-backward\"></i>\n        </span>\n        <span>Prec</span>\n      </button>\n    </p>\n    <p class=\"control\">\n      <button class=\"button\"\n              :class=\"[ playerState.isPlaying ? 'is-danger' : 'is-primary' ]\"\n              @click=\"togglePlay()\">\n        <span class=\"icon is-small\">\n          <i class=\"fa\"\n             :class=\"[ playerState.isPlaying ? 'fa-stop' : 'fa-play' ]\">\n          </i>\n        </span>\n        <span>Play</span>\n      </button>\n    </p>\n    <p class=\"control\">\n      <button class=\"button is-rounded\"\n              :disabled=\"playerState.isEnd || playerState.isPlaying\"\n              @click=\"next()\">\n        <span class=\"icon is-small\">\n          <i class=\"fa fa-forward\"></i>\n        </span>\n        <span>Next</span>\n      </button>\n    </p>\n  </div>\n</template>","import {createApp} from 'vue';\nimport {Player} from './player';\nimport PlayerComponent from './components/player.component.vue';\n\nwindow.ready = new Promise((resolve, reject) => {\n    window.onload = () => {\n        const videoElem = document.getElementById('video');\n        window.Player = new Player(videoElem!, window.captions);\n\n        createApp({})\n            .component('player', PlayerComponent)\n            .mount('#player-controller');\n\n        resolve();\n    };\n});\n"],"names":["reactive","createApp","PlayerComponent"],"mappings":"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"}